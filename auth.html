<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ff6f61">

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FurTagPH — Auth</title>
<link rel="icon" type="image/x-icon" href="favicon.ico">

<!-- Swiper -->
<link rel="stylesheet" href="https://unpkg.com/swiper@9/swiper-bundle.min.css" />
<script src="https://unpkg.com/swiper@9/swiper-bundle.min.js"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<style>
  :root{
    --brand-1:#ff6f61; --brand-2:#ff896f; --bg:#fbfbfc; --muted:#666; --radius:14px;
  }

  html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,system-ui,Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased; -webkit-touch-callout:none;}

  /* intro full-screen mp4 */
  .intro { position:fixed; inset:0; z-index:1200; display:flex; align-items:center; justify-content:center; background:black; transition:opacity .6s ease, visibility .6s; visibility:visible; opacity:1; }
  .intro.hidden { opacity:0; visibility:hidden; pointer-events:none; }
  .intro video { width:100%; height:100%; object-fit:cover; }

  /* app container */
  .app { position:relative; z-index:10; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px; }
  .card { width:100%; max-width:920px; border-radius:var(--radius); background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,255,255,0.99)); box-shadow:0 28px 60px rgba(6,10,20,0.07); overflow:visible; }
  .header { display:flex; align-items:center; gap:12px; padding:16px 18px; background:linear-gradient(90deg,var(--brand-1),var(--brand-2)); color:white; border-top-left-radius:var(--radius); border-top-right-radius:var(--radius); }
  .header img { height:44px; border-radius:8px; }
  .header h2 { margin:0; font-size:16px; font-weight:600; }

  /* SWIPER adjustments */
  .swiper { width:100%; height:auto; }             /* let swiper decide height per-slide */
  /* IMPORTANT: use flex-start so slides size independently (not stretch to tallest) */
  .swiper-wrapper { align-items:flex-start; }
  .swiper-slide { display:flex; padding:18px; box-sizing:border-box; height:auto !important; align-items:flex-start; } /* ensure slides are auto height */

  /* forms - base */
  .form { width:100%; max-width:560px; margin:auto; box-sizing:border-box; padding:8px 12px 20px 12px; background:transparent; }
  label{ display:block; margin:10px 0 6px; font-size:13px; color:#333; }
  input[type="text"], input[type="email"], input[type="password"], input[type="tel"], textarea, select {
    width:100%; padding:10px 12px; font-size:15px; border-radius:10px; border:1px solid #e6e6e6; box-sizing:border-box; background:white;
  }
  textarea { min-height:70px; resize:vertical; }
  .row { display:flex; gap:10px; }
  .row .col { flex:1; }

  .btn { display:inline-block; width:100%; padding:12px; border-radius:10px; border:0; color:white; background:linear-gradient(90deg,var(--brand-1),var(--brand-2)); font-weight:700; font-size:15px; cursor:pointer; }
  .btn.secondary { background:#fff; color:#333; border:1px solid #eee; box-shadow:0 6px 18px rgba(0,0,0,0.03); }
  .btn[disabled]{ opacity:.65; cursor:not-allowed; }

  .muted { color:var(--muted); font-size:13px; margin-top:8px; }
  .error { color:#b00020; font-size:13px; margin-top:8px; min-height:18px; }

  /* compact center for short forms (login/reset) */
  .form.centered { display:flex; flex-direction:column; justify-content:center; align-items:stretch; min-height:180px; }

  /* tall scrollable signup form */
  /* touch-action: pan-y allows vertical gestures to go to the map/form while horizontal swipes bubble to the swiper */
  .form.tall { max-height: calc(80vh); overflow:auto; padding-bottom:24px; -webkit-overflow-scrolling:touch; touch-action: pan-y; -ms-touch-action: pan-y; }

  /* slide-in animation for form content */
  .form { transform: translateX(18px); opacity: 0; transition: transform .36s cubic-bezier(.2,.9,.2,1), opacity .32s ease; }
  .swiper-slide-active .form { transform: translateX(0); opacity: 1; }

  /* map */
  #map { width:100%; height:320px; border-radius:10px; border:1px solid #e6e6e6; margin-top:8px; touch-action: pan-y; -ms-touch-action: pan-y; } /* pan-y: vertical scroll on map, horizontal to swiper */
  input[type="hidden"]{ display:none; }

  /* pagination styling (kept) */
  .swiper-pagination-bullet { opacity: 0.6; background: #ddd; }
  .swiper-pagination-bullet-active { background: var(--brand-1); opacity: 1; }

  /* responsive */
  @media (max-width:720px){
    .card{ margin:0 8px; border-radius:12px; }
    #map{ height:240px; }
    .form.centered { min-height: 150px; }
    .form.tall{ max-height: 70vh; }
  }
</style>
</head>
<body>

<!-- Fullscreen MP4 intro -->
<div id="intro" class="intro" role="img" aria-label="Intro">
  <video id="introVideo" autoplay muted playsinline>
    <source src="FurtagPH.mp4" type="video/mp4">
  </video>
</div>

<div class="app">
  <div id="card" class="card" role="main" aria-labelledby="appTitle">
    <div class="header">
      <img src="FurTagPH.png" alt="FurTagPH Logo">
      <h2 id="appTitle">FurTagPH — Account</h2>
    </div>

    <!-- swiper -->
    <div class="swiper" id="authSwiper">
      <div class="swiper-wrapper">

        <!-- LOGIN (compact centered) -->
        <div class="swiper-slide" aria-label="Login">
          <div class="form centered" id="loginSlide">
            <h3 style="margin:0 0 8px 0">Login</h3>

            <label for="loginEmail">Email</label>
            <input id="loginEmail" type="email" autocomplete="email" placeholder="you@example.com">

            <label for="loginPassword">Password</label>
            <input id="loginPassword" type="password" autocomplete="current-password" placeholder="••••••">

            <div style="margin-top:14px">
              <button id="loginBtn" class="btn" type="button">Sign in</button>
            </div>

            <div id="loginError" class="error" role="alert"></div>

            <div class="muted" style="margin-top:12px; display:flex; gap:8px; justify-content:space-between; align-items:center">
              <small>Don't have an account? <a href="#" id="linkToSignup">Sign up</a></small>
              <small><a href="#" id="linkToReset">Forgot password?</a></small>
            </div>
          </div>
        </div>

        <!-- SIGNUP (tall & scrollable) -->
        <div class="swiper-slide" aria-label="Sign Up">
          <div class="form tall" id="signupSlide">
            <h3 style="margin:0 0 8px 0">Sign Up</h3>

            <label>Full name</label>
            <input id="fullName" type="text" placeholder="Juan dela Cruz" autocomplete="name">

            <label>Phone number</label>
            <input id="phoneNumber" type="tel" placeholder="+63 9xx xxx xxxx" autocomplete="tel">

            <label>Email</label>
            <input id="emailAddress" type="email" placeholder="you@example.com" autocomplete="email">

            <div class="row" style="margin-top:8px;">
              <div class="col">
                <label>Facebook</label>
                <input id="facebookLink" type="text" placeholder="https://facebook.com/yourprofile">
              </div>
              <div class="col">
                <label>Instagram</label>
                <input id="instagramLink" type="text" placeholder="https://instagram.com/yourprofile">
              </div>
            </div>

            <label style="margin-top:10px">Address</label>
            <input id="street" type="text" placeholder="Street / Barangay">
            <div class="row" style="margin-top:8px">
              <div class="col"><input id="city" type="text" placeholder="City"></div>
              <div class="col"><input id="province" type="text" placeholder="Province / State"></div>
            </div>
            <div class="row" style="margin-top:8px">
              <div class="col"><input id="country" type="text" placeholder="Country"></div>
              <div style="width:140px"><input id="zipcode" type="text" placeholder="Zipcode"></div>
            </div>

            <label style="margin-top:10px">Location (drag pin)</label>
            <div id="map" aria-hidden="false"></div>

            <!-- hidden lat/lng -->
            <input id="lat" type="hidden">
            <input id="lng" type="hidden">

            <div class="row" style="margin-top:10px">
              <div class="col">
                <label>Password</label>
                <input id="password" type="password" placeholder="Create password" autocomplete="new-password">
              </div>
              <div class="col">
                <label>Confirm Password</label>
                <input id="password2" type="password" placeholder="Confirm password" autocomplete="new-password">
              </div>
            </div>

            <div style="margin-top:12px; display:flex; gap:8px;">
              <button id="signupBtn" class="btn" type="button">Create account</button>
              <button class="btn secondary" type="button" onclick="clearSignupForm()">Clear</button>
            </div>

            <div id="signupError" class="error"></div>
            <div class="muted" style="margin-top:10px">We store your profile in Firestore (collection <code>users</code>). Passwords are managed by Firebase Auth.</div>
          </div>
        </div>

        <!-- RESET (compact centered) -->
        <div class="swiper-slide" aria-label="Reset Password">
          <div class="form centered" id="resetSlide">
            <h3 style="margin:0 0 8px 0">Reset Password</h3>
            <label>Email</label>
            <input id="resetEmail" type="email" placeholder="you@example.com">
            <div style="margin-top:12px">
              <button id="resetBtn" class="btn" type="button">Send reset email</button>
            </div>
            <div id="resetMsg" class="muted" style="margin-top:8px"></div>
            <div id="resetError" class="error"></div>
            <div style="margin-top:14px" class="muted"><a href="#" id="linkBackToLogin">Back to login</a></div>
          </div>
        </div>

      </div>

      <!-- pagination (kept) -->
      <div class="swiper-pagination"></div>

      <!-- NOTE: arrows removed intentionally to match your request -->
    </div><!-- end swiper -->
  </div><!-- end card -->
</div><!-- end app -->

<script>
/* ========== FIREBASE ========== */
const firebaseConfig = {
  apiKey: "AIzaSyCARXD0ZyOfgyrvsY9KiVXs4VwloiumiHE",
  authDomain: "furtagph-cf3d3.firebaseapp.com",
  projectId: "furtagph-cf3d3",
  storageBucket: "furtagph-cf3d3.firebasestorage.app",
  messagingSenderId: "639123411408",
  appId: "1:639123411408:web:737d4aa4a54b414dcda9d5",
  measurementId: "G-GHPYPB8XW8"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ========== INTRO (mp4) ------------- */
const introEl = document.getElementById('intro');
const introVideo = document.getElementById('introVideo');
const INTRO_MS = 3000;
let introTimer = setTimeout(() => fadeIntro(), INTRO_MS);
introVideo.addEventListener('ended', () => fadeIntro());
function fadeIntro(){
  if(!introEl.classList.contains('hidden')){
    introEl.classList.add('hidden');
    // after intro fades, ensure swiper/map sizing runs
    setTimeout(()=> {
      try { if(swiper) { swiper.update(); swiper.allowTouchMove = true; } } catch(e){}
      maybeInitMap();
    }, 320);
  }
}

/* ========== SWIPER ========== */
let swiper = null;
function initSwiper(){
  if(swiper) return;
  swiper = new Swiper('#authSwiper', {
    direction: 'horizontal',
    speed: 420,
    slidesPerView: 1,
    spaceBetween: 0,
    grabCursor: true,
    simulateTouch: true,
    threshold: 8,
    resistanceRatio: .85,
    watchOverflow: true,
    autoHeight: true,                // let swiper auto-size per-slide
    touchStartPreventDefault: false,
    touchStartForcePreventDefault: false,
    nested: true,
    touchAngle: 20,                  // better separate horizontal vs vertical gestures
    pagination: { el: '.swiper-pagination', clickable: true }
    // navigation intentionally removed (no arrows)
  });

  // lock swipe while intro plays (will be unlocked in fadeIntro)
  swiper.allowTouchMove = false;

  swiper.on('slideChange', function(){
    // lazy-init map when signup shows and ensure sizing
    maybeInitMap();
    // small timeout for animation settle
    setTimeout(()=> { try { if(map) map.invalidateSize(); } catch(e){} }, 160);
  });
}
document.addEventListener('DOMContentLoaded', initSwiper);

/* helper to go to slide programmatically */
function goToSlide(i){
  if(!swiper) initSwiper();
  swiper.slideTo(i, 360);
}

/* wire up clickable links to jump safely (elements are present because script is placed at end) */
const safeOn = (id, fn) => { const el = document.getElementById(id); if(el) el.addEventListener('click', e => { e.preventDefault(); fn(e); }); };
safeOn('linkToSignup', ()=> goToSlide(1));
safeOn('linkToReset', ()=> goToSlide(2));
safeOn('linkBackToLogin', ()=> goToSlide(0));

/* ========== LEAFLET MAP (lazy init) ========== */
let map = null, marker = null, mapInitialized = false;
function maybeInitMap(){
  if(!swiper) { setTimeout(maybeInitMap, 200); return; }
  // only init when signup slide is active
  if(mapInitialized){
    if(swiper.activeIndex===1) setTimeout(()=> { if(map) map.invalidateSize(); }, 80);
    return;
  }
  if(swiper.activeIndex !== 1) return;
  mapInitialized = true;

  const defaultLat = 14.599512, defaultLng = 120.984222;
  map = L.map('map', { center: [defaultLat, defaultLng], zoom: 6, zoomControl: true });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

  marker = L.marker([defaultLat, defaultLng], { draggable:true }).addTo(map);
  marker.on('dragend', () => {
    const p = marker.getLatLng();
    document.getElementById('lat').value = p.lat.toFixed(6);
    document.getElementById('lng').value = p.lng.toFixed(6);
  });

  // allow clicking on map to move pin
  map.on('click', e => {
    if(marker) marker.setLatLng(e.latlng);
    else marker = L.marker(e.latlng, { draggable:true }).addTo(map);
    const p = e.latlng;
    document.getElementById('lat').value = p.lat.toFixed(6);
    document.getElementById('lng').value = p.lng.toFixed(6);
  });

  // set hidden inputs
  const p = marker.getLatLng();
  document.getElementById('lat').value = p.lat.toFixed(6);
  document.getElementById('lng').value = p.lng.toFixed(6);

  // Ensure map tiles render well when slide becomes visible
  setTimeout(()=> { if(map) map.invalidateSize(); }, 120);
}

/* ========== AUTH ACTIONS ========== */
function setText(id, txt){ const e=document.getElementById(id); if(e) e.textContent = txt; }
function clearErrors(){ setText('loginError',''); setText('signupError',''); setText('resetError',''); setText('resetMsg',''); }

/* LOGIN */
document.getElementById('loginBtn').addEventListener('click', async () => {
  clearErrors();
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  if(!email || !password){ setText('loginError','Please enter email and password'); return; }
  try {
    document.getElementById('loginBtn').disabled = true;
    await auth.signInWithEmailAndPassword(email, password);
    window.location.href = 'furboard.html';
  } catch(err){
    setText('loginError', err.message || 'Login failed');
  } finally { document.getElementById('loginBtn').disabled = false; }
});

/* RESET */
document.getElementById('resetBtn').addEventListener('click', async () => {
  clearErrors();
  const email = document.getElementById('resetEmail').value.trim();
  if(!email){ setText('resetError','Enter an email'); return; }
  try {
    document.getElementById('resetBtn').disabled = true;
    await auth.sendPasswordResetEmail(email);
    setText('resetMsg','Password reset email sent (check inbox/spam).');
  } catch(err){
    setText('resetError', err.message || 'Failed to send reset email');
  } finally { document.getElementById('resetBtn').disabled = false; }
});

/* SIGNUP */
document.getElementById('signupBtn').addEventListener('click', async () => {
  clearErrors();
  const fullName = document.getElementById('fullName').value.trim();
  const phoneNumber = document.getElementById('phoneNumber').value.trim();
  const emailAddress = document.getElementById('emailAddress').value.trim();
  const facebookLink = document.getElementById('facebookLink').value.trim();
  const instagramLink = document.getElementById('instagramLink').value.trim();
  const street = document.getElementById('street').value.trim();
  const city = document.getElementById('city').value.trim();
  const province = document.getElementById('province').value.trim();
  const country = document.getElementById('country').value.trim();
  const zipcode = document.getElementById('zipcode').value.trim();
  const lat = document.getElementById('lat').value.trim();
  const lng = document.getElementById('lng').value.trim();
  const password = document.getElementById('password').value;
  const password2 = document.getElementById('password2').value;

  if(!fullName || !emailAddress || !password || !password2){ setText('signupError','Full name, email and password are required'); return; }
  if(password.length < 6){ setText('signupError','Password must be at least 6 characters'); return; }
  if(password !== password2){ setText('signupError','Passwords do not match'); return; }

  try {
    document.getElementById('signupBtn').disabled = true;
    const cred = await auth.createUserWithEmailAndPassword(emailAddress, password);
    const uid = cred.user.uid;

    const profile = {
      fullName,
      phoneNumber,
      emailAddress,
      facebookLink,
      instagramLink,
      address: { street, city, province, country, zipcode },
      location: { lat: lat ? Number(lat) : null, lng: lng ? Number(lng) : null },
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    await db.collection('users').doc(uid).set(profile);
    window.location.href = 'furboard.html';
  } catch(err) {
    setText('signupError', err.message || 'Sign up failed');
  } finally {
    document.getElementById('signupBtn').disabled = false;
  }
});

/* clear signup */
function clearSignupForm(){
  const ids = ['fullName','phoneNumber','emailAddress','facebookLink','instagramLink','street','city','province','country','zipcode','password','password2'];
  ids.forEach(i => { const el=document.getElementById(i); if(el) el.value=''; });
  if(marker){
    const p = marker.getLatLng();
    document.getElementById('lat').value = p.lat.toFixed(6);
    document.getElementById('lng').value = p.lng.toFixed(6);
  } else { document.getElementById('lat').value = ''; document.getElementById('lng').value = ''; }
}

/* initialize swiper & optionally map after load; if intro hasn't yet finished, swiper stays locked */
window.addEventListener('load', () => {
  // init swiper (if not already)
  initSwiper();
  // if intro already hidden (video ended early), allow swipe
  if(introEl.classList.contains('hidden')) {
    try { swiper.allowTouchMove = true; } catch(e){}
  }
});

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js')
    .then(() => console.log('Service Worker registered'))
    .catch(err => console.log('Service Worker failed:', err));
}


/* NOTE: If you open the file via file:// you may see origin warnings.
   Serve via a local webserver (python -m http.server or Live Server) for Leaflet and Firebase to behave properly. */
</script>
</body>
</html>
